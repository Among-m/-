# 更新日志

## [2025-10-01] 用户管理系统重大更新

### 🎉 新增功能

#### 用户管理页面全面升级
1. **显示所有注册用户**
   - 现在显示所有通过API注册的用户（`app_users`表）
   - 不再限于只显示使用了卡密的用户
   - 自动关联显示用户绑定的所有卡密信息

2. **完整的CRUD功能**
   - ✅ 添加用户：支持手动添加新用户
   - ✅ 查看详情：点击"查看"按钮打开详情弹窗
   - ✅ 编辑用户：可修改用户名、邮箱、手机号、VIP等级、余额、状态
   - ✅ 删除用户：支持单个删除和批量删除

3. **用户详情弹窗**
   - 显示用户基本信息（ID、用户名、邮箱、手机号）
   - 显示用户等级（普通/VIP/SVIP）
   - 显示注册时间、最后登录时间、登录次数
   - 显示设备信息（设备ID、设备型号）
   - 显示用户余额
   - 显示绑定的所有卡密列表（包括有效期、状态等）
   - 支持直接禁用用户

4. **多选批量操作**
   - 支持复选框多选用户
   - 全选/取消全选功能
   - 批量删除选中的用户

5. **搜索和筛选**
   - 搜索：支持按用户名、邮箱、手机号、设备ID搜索
   - 筛选：支持按状态（启用/禁用）和VIP等级筛选
   - 重置按钮：一键清除所有筛选条件

6. **数据展示优化**
   - 显示用户的VIP等级徽章
   - 显示绑定卡密数量（有效/已过期）
   - 显示登录次数和最后登录时间
   - 优化表格布局，信息更加清晰

### 🛠️ 后端API更新

新增以下API接口：
- `get_user` - 获取单个用户信息（用于编辑）
- `get_user_detail` - 获取用户详细信息（包括卡密列表）
- `save_user` - 保存用户（新增或更新）
- `delete_user` - 删除单个用户
- `batch_delete` - 批量删除用户
- `ban_user` - 禁用/启用用户

### 📝 数据验证
- 用户名格式验证（仅允许字母、数字、下划线）
- 用户名唯一性检查
- 邮箱唯一性检查
- 手机号唯一性检查
- 密码强度要求（最少6位）

### 🎨 界面优化
- 采用Bootstrap 5现代化UI设计
- 响应式弹窗设计
- 加载状态提示
- 友好的错误提示
- 操作确认对话框

### 📊 日志记录
所有用户管理操作都会记录到操作日志：
- 添加用户
- 编辑用户
- 删除用户
- 批量删除用户
- 禁用/启用用户

### 🔒 安全性
- 密码使用bcrypt加密存储
- Token自动生成和管理
- 数据库事务保证数据一致性
- SQL注入防护
- XSS防护（HTML转义）

---

## 使用说明

### 访问用户管理
登录管理后台后，点击左侧菜单的"用户管理"即可进入。

### 查看用户详情
点击用户列表中的"眼睛"图标，会打开详情弹窗，显示：
- 用户头像和基本信息
- VIP等级和状态
- 注册和登录信息
- 设备信息
- 绑定的卡密列表

### 添加用户
1. 点击右上角"添加用户"按钮
2. 填写用户信息（用户名、密码、邮箱等）
3. 选择VIP等级和状态
4. 点击"保存"

### 编辑用户
1. 点击用户列表中的"铅笔"图标
2. 修改需要更新的信息
3. 密码留空表示不修改密码
4. 点击"保存"

### 批量删除
1. 勾选需要删除的用户
2. 点击右上角出现的"批量删除"按钮
3. 确认删除操作

### 搜索用户
1. 在搜索框输入关键词（用户名/邮箱/手机号）
2. 按Enter键或点击"搜索"按钮
3. 可配合状态和VIP等级筛选使用

---

## 技术细节

### 数据库表
主要使用 `app_users` 表存储注册用户：
- `id` - 用户ID
- `username` - 用户名
- `password` - 密码（bcrypt加密）
- `email` - 邮箱
- `phone` - 手机号
- `vip_level` - VIP等级（0=普通，1=VIP，2=SVIP）
- `balance` - 余额
- `status` - 状态（0=禁用，1=启用）
- `device_id` - 设备ID
- `device_model` - 设备型号
- `token` - 登录令牌
- `login_count` - 登录次数
- `last_login` - 最后登录时间
- `created_at` - 注册时间

### API响应格式
```json
{
  "success": true,
  "message": "操作成功",
  "data": { ... }
}
```

### 前端技术
- Bootstrap 5 - UI框架
- Bootstrap Icons - 图标库
- Fetch API - AJAX请求
- 原生JavaScript - 交互逻辑

---

## 兼容性说明
- 向后兼容，不影响现有功能
- 原有的 `users` 表（卡密用户）保持不变
- API接口保持不变



