# 完整多租户隔离升级指南

## 🎉 更新内容

本次升级实现了**完整的多租户数据隔离**，让系统支持真正的裂变和代理分销模式。

### 核心改进

1. **超级管理员 vs 普通管理员**
   - `super_admin` - 超级管理员，可以看到所有数据
   - `admin` - 普通管理员，只能看到自己创建的数据

2. **完整的数据隔离**
   - ✅ 项目管理 - 只显示自己创建的项目
   - ✅ 卡密管理 - 只显示自己项目的卡密
   - ✅ 用户管理 - 只显示自己项目的用户
   - ✅ API Key - 只显示自己项目的令牌
   - ✅ 操作日志 - 只显示自己的操作记录
   - ✅ 数据概览 - 只统计自己的数据

3. **字段名称优化**
   - 项目的"包名"改为"API接口"
   - 更符合实际使用场景

## 📊 数据库更新

**已经在之前完成，无需再次操作：**
- `projects` 表已添加 `admin_id` 字段
- `app_users` 表已添加 `project_id` 字段

## 🔧 升级步骤

### 方式1：删除旧数据库（推荐）

如果你的数据是测试数据，最简单的方法：

```bash
# 1. 删除数据库文件
删除 data.db 文件

# 2. 刷新管理后台
访问后台任意页面，系统自动创建新表结构

# 3. 使用默认账号登录
用户名: admin
密码: admin123456
角色: super_admin（超级管理员）
```

### 方式2：保留数据并更新（已有正式数据）

```sql
-- 已经执行过的操作（无需重复）：
-- 1. 给项目表添加管理员ID（默认归属第一个管理员）
UPDATE projects SET admin_id = 1 WHERE admin_id IS NULL OR admin_id = 0;

-- 2. 给用户表添加项目ID（默认归属第一个项目）
UPDATE app_users SET project_id = 1 WHERE project_id IS NULL OR project_id = 0;
```

## 👥 管理员角色说明

### 超级管理员（super_admin）

**权限：**
- ✅ 查看所有管理员的项目
- ✅ 查看所有项目的卡密
- ✅ 查看所有项目的用户
- ✅ 查看所有API Key
- ✅ 查看所有操作日志
- ✅ 管理子管理员账号

**适用场景：**
- 平台总管理员
- 系统维护人员
- 数据分析人员

### 普通管理员（admin）

**权限：**
- ✅ 只能创建和管理自己的项目
- ✅ 只能看到自己项目的卡密
- ✅ 只能看到自己项目的用户
- ✅ 只能看到自己项目的API Key
- ✅ 只能看到自己的操作日志
- ❌ 看不到其他管理员的任何数据

**适用场景：**
- 代理商
- 分销商
- 独立客户

## 🎯 使用场景示例

### 场景1：代理分销模式

```
主账号（super_admin）
├── 代理商A（admin）
│   ├── 项目1: A公司-计步APP
│   ├── 项目2: A公司-阅读APP
│   └── 用户: 500人
├── 代理商B（admin）
│   ├── 项目1: B公司-健身APP
│   └── 用户: 300人
└── 代理商C（admin）
    ├── 项目1: C公司-记账APP
    └── 用户: 200人
```

**效果：**
- 主账号看到所有数据（1000人）
- 代理商A只看到自己的500人
- 代理商B只看到自己的300人
- 代理商C只看到自己的200人

### 场景2：多客户SaaS模式

```
平台（super_admin）
├── 客户A公司（admin）
│   ├── Android版
│   └── iOS版
├── 客户B公司（admin）
│   └── Web版
└── 客户C公司（admin）
    └── 小程序版
```

## 🧪 测试指南

### 1. 创建测试账号

登录超级管理员账号（admin），进入"管理员"页面：

```
账号1（超级管理员）：
用户名: admin
密码: admin123456
角色: super_admin

账号2（普通管理员）：
用户名: agent1
密码: 123456
角色: admin

账号3（普通管理员）：
用户名: agent2
密码: 123456
角色: admin
```

### 2. 测试数据隔离

**步骤1：使用admin（超级管理员）登录**
```
1. 创建项目A
2. 为项目A生成10个卡密
3. 查看数据概览，记录统计数字
```

**步骤2：使用agent1登录**
```
1. 创建项目B
2. 为项目B生成10个卡密
3. 查看数据概览
   ✅ 应该只看到1个项目
   ✅ 应该只看到10个卡密
   ✅ 看不到项目A的数据
```

**步骤3：使用agent2登录**
```
1. 创建项目C
2. 为项目C生成5个卡密
3. 查看数据概览
   ✅ 应该只看到1个项目
   ✅ 应该只看到5个卡密
   ✅ 看不到项目A和B的数据
```

**步骤4：切回admin（超级管理员）**
```
查看数据概览：
✅ 应该看到3个项目（A、B、C）
✅ 应该看到25个卡密（10+10+5）
✅ 项目列表显示每个项目的创建者
```

### 3. 测试各个页面

#### 项目管理页面
- 普通管理员：只显示自己创建的项目
- 超级管理员：显示所有项目，并显示"管理员"列

#### 卡密管理页面
- 普通管理员：只能看到和操作自己项目的卡密
- 超级管理员：可以看到所有卡密

#### 用户管理页面
- 普通管理员：只能看到自己项目下注册的用户
- 超级管理员：可以看到所有用户

#### API Key管理
- 普通管理员：只能看到自己项目的令牌
- 超级管理员：可以看到所有令牌，并显示"管理员"列

#### 操作日志
- 普通管理员：只能看到自己的操作记录
- 超级管理员：可以看到所有管理员的操作记录

#### 数据概览
- 普通管理员：只统计自己的数据
- 超级管理员：统计所有数据

## 📱 API使用说明

### 用户注册接口（必须指定API Key）

**新版本请求格式：**
```json
POST /api.php
{
  "action": "register",
  "token": "your_api_token_here",          // 必填！API Key
  "username": "testuser",
  "password": "123456",
  "email": "test@example.com",
  "phone": "13800138000",
  "device_id": "device_123",
  "device_model": "Xiaomi 13"
}
```

**如何获取API Key：**
1. 管理员登录后台
2. 进入"API Key管理"
3. 为项目生成API Key
4. 复制API Key用于API调用

**注意：**
- 不同项目的用户数据完全隔离
- 只有项目创建者能看到该项目的用户

## 🔍 界面变化说明

### 项目管理
- 新增"管理员"列（仅超级管理员可见）
- "包名"改为"API接口"
- 创建项目自动关联当前管理员

### 卡密管理
- 筛选项目时只显示自己的项目
- 导出功能只能导出自己的卡密

### 用户管理
- 新增"项目"列，显示用户所属项目
- 添加用户时必须选择项目
- 只显示自己项目的用户

### API Key
- 新增"管理员"列（仅超级管理员可见）
- 只能为自己的项目生成令牌

### 操作日志
- 普通管理员只看到自己的操作记录
- 超级管理员可以看到所有操作

### 数据概览
- 统计数据根据权限自动调整
- 最近激活的卡密只显示自己项目的
- 最近操作日志只显示自己的

## 💡 最佳实践

### 1. 账号分配建议

```
超级管理员账号：
- 数量：1-2个
- 用途：平台管理、数据分析、问题排查
- 保管：由平台核心人员持有

普通管理员账号：
- 数量：不限
- 用途：代理商、客户、分销商
- 分配：为每个代理商/客户创建独立账号
```

### 2. 项目命名规范

```
推荐格式：公司名-产品名-平台
示例：
- 张三公司-计步APP-Android
- 张三公司-计步APP-iOS
- 李四公司-阅读器-小程序
```

### 3. 数据安全建议

- 定期备份数据库
- 为每个代理商使用不同的项目ID
- API Key及时更新
- 监控操作日志，发现异常及时处理

## ❓ 常见问题

### Q1: 如何将现有admin账号设置为超级管理员？

```sql
UPDATE admins SET role = 'super_admin' WHERE username = 'admin';
```

### Q2: 如何创建新的普通管理员？

在"管理员"页面添加，角色选择"admin"（不要选super_admin）

### Q3: 普通管理员能看到其他管理员吗？

不能。管理员页面也根据权限隔离，普通管理员看不到其他管理员的信息。

### Q4: 如何转移项目给其他管理员？

超级管理员可以在数据库中修改：
```sql
UPDATE projects SET admin_id = 新管理员ID WHERE id = 项目ID;
```

### Q5: 用户注册时项目ID填错了怎么办？

超级管理员可以在数据库中修改：
```sql
UPDATE app_users SET project_id = 正确的项目ID WHERE id = 用户ID;
```

### Q6: 删除管理员会怎样？

删除管理员会级联删除：
- 该管理员创建的所有项目
- 所有项目下的卡密
- 所有项目下的用户
- 所有项目的API Key

**请谨慎操作！**

## 🎨 界面截图说明

### 超级管理员视图
- 项目列表显示"管理员"列
- API Key显示"管理员"列
- 统计数据显示全部数据

### 普通管理员视图
- 只显示自己的数据
- 没有"管理员"列
- 统计数据只包含自己的

## 🔄 升级后的工作流程

### 代理商注册用户流程

```
1. 平台创建代理商账号（admin角色）
2. 代理商登录后台
3. 代理商创建自己的项目
4. 记录项目ID（如：5）
5. 在APP中使用project_id=5注册用户
6. 用户归属于该代理商，只有该代理商能看到
```

### 裂变推广流程

```
1. 主账号邀请子代理
2. 为子代理创建管理员账号
3. 子代理创建自己的项目推广
4. 子代理发展的用户归属于子代理
5. 主账号可以看到所有数据统计
6. 各子代理只能看到自己的数据
```

## 📞 技术支持

如遇问题，请提供：
1. 管理员角色（super_admin/admin）
2. 操作步骤
3. 错误截图
4. 期望结果 vs 实际结果

---

## ✅ 功能检查清单

升级完成后，请逐项验证：

- [ ] 删除旧数据库并重新初始化
- [ ] 默认admin账号可以登录
- [ ] 创建第二个管理员账号（admin角色）
- [ ] 第二个账号登录后看不到admin的数据
- [ ] 两个账号分别创建项目
- [ ] 两个账号分别生成卡密
- [ ] 使用不同project_id注册用户
- [ ] 验证用户数据隔离
- [ ] 验证卡密数据隔离
- [ ] 验证API Key隔离
- [ ] 验证操作日志隔离
- [ ] 验证数据统计隔离
- [ ] admin（super_admin）能看到所有数据

全部打勾即表示升级成功！🎉

